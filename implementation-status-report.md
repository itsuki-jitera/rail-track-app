# 計画線実装状況レポート

## 仕様書要件と現在の実装状況の比較

### 1. チャート表示について

#### 仕様書の要件：
- ✅ **作業方向基準**: MTT施工を考慮し、作業方向を基準に表示
  - 実装状況: WorkSectionPage.tsxで作業方向（forward/backward）を設定可能

- ⚠️ **左右の定義**: 作業方向を向いて左・右とする
  - 実装状況: 部分的実装。レール左右の明確な区別は未完全

- ⚠️ **チャート方向**: 作業方向が左から右になるように表示
  - 実装状況: ChartDisplay.tsxでは距離順表示だが、作業方向の反映が不十分

- ⚠️ **通り狂い表示**: 軌道を上から見た位置関係で表示
  - 実装状況: 基本的なチャート表示はあるが、視点の明確化が必要

- ✅ **高低狂い表示**: 軌道を横から見た位置関係で表示
  - 実装状況: ChartDisplay.tsxで実装済み

- ⚠️ **キロ程計算**: データ数×データ間隔で実延長を表す
  - 実装状況: 距離表示はあるが、キロ程との対応が不明確

- ❌ **WB区間のキロ程**: ラボックスの元データをそのまま使用
  - 実装状況: WB区間の特別処理は未実装

### 2. 復元波形と移動量について

#### 仕様書の要件：
- ✅ **復元波形の概念**: 実際の軌道形状を表す
  - 実装状況: restoration-filter.jsで実装済み

- ⚠️ **移動量計算**: 復元波形をゼロ点まで移動する量
  - 実装状況: 基本概念は実装されているが、詳細な移動量計算が不明確

- ⚠️ **計画線の定義**: 復元波形のゼロ点を結んだ線
  - 実装状況: PlanLinePage.tsxに計画線設定はあるが、ゼロ点との関係が不明確

- ❌ **こう上優先**: 高低狂いはなるべく「こう上」になるように計画線を変更
  - 実装状況: 未実装

- ✅ **復元波長範囲の制限**:
  - 下限: 6m（新幹線高低は3.5-6m選択可能、通りは試行的に15mも可能）
    - 実装状況: restoration-filter.jsで実装済み
  - 上限: 最高列車速度の1.5-2倍を目安
    - 実装状況: デフォルト値は設定済み（通り100m、高低40m）

### 3. 通り狂いの処理について

#### 仕様書の要件：
- ❌ **補正率**: マヤ車の通り狂い正矢を補正（通常1.0）
  - 実装状況: 未実装

- ⚠️ **曲線諸元の台形差引**: 通り狂いから曲線諸元を差し引いて計算
  - 実装状況: 曲線諸元設定はあるが、台形差引処理は不明確

### 4. 移動量について

#### 仕様書の要件：
- ❌ **MTT種別対応**: MTTフロント誘導のためALS用移動量を補正
  - 実装状況: 未実装

### 5. 手検測軌道狂いについて

#### 仕様書の要件：
- ⚠️ **位置対応付け**: チャート上の点と現地位置の正確な対応
  - 実装状況: HandMeasurementPage.tsxはあるが、位置対応機能は不明確

- ❌ **波形比較**: ±20m以内で相関係数最大位置を検索
  - 実装状況: 未実装

### 6. その他の留意点

#### 仕様書の要件：
- ⚠️ **長波長成分の非対象**: 曲線線形のような長波長は整備対象外
  - 実装状況: 復元波長範囲の設定はあるが、明示的な説明が必要

- ❌ **駅付近の慎重な適用**: 不動点制約での緩和曲線延伸箇所への配慮
  - 実装状況: 未実装

- ❌ **MTT ALS誤差の考慮**: 整備誤差の可能性を考慮
  - 実装状況: 未実装

## 推奨される改善点

### 優先度: 高
1. **作業方向に基づくチャート表示の改善**
   - ChartDisplay.tsxで作業方向を考慮した表示順序の実装
   - 左右レールの明確な区別

2. **こう上優先の計画線生成**
   - 下方向修正を最小限にする凸型計画線アルゴリズムの強化

3. **WB区間の特別処理**
   - キロ程データの適切な処理
   - WB区間の識別と表示

### 優先度: 中
4. **移動量計算の明確化**
   - 復元波形からゼロ点への移動量計算の実装
   - 移動量制限との連携

5. **手検測データとの位置合わせ**
   - 相関係数による自動位置合わせ機能

6. **通り狂い補正率の実装**
   - マヤ車データの補正機能追加

### 優先度: 低
7. **MTT種別対応**
   - ALS用移動量データの補正機能

8. **駅付近での特別処理**
   - 不動点制約の考慮

## 現在の実装の良い点

1. **基本的な復元波形計算**: FFTベースの復元フィルタが実装済み
2. **復元波長範囲の設定**: 新幹線/在来線での適切なデフォルト値
3. **UIの基本構造**: ワークフロー管理と各ステップの連携
4. **データ管理**: グローバル状態管理による一貫性

## 結論

現在の実装は基本的な機能は備えていますが、実運用に必要な詳細機能がいくつか不足しています。特に、作業方向を考慮したチャート表示、こう上優先の計画線生成、WB区間の特別処理などが重要な改善点として挙げられます。

凡例：
- ✅ 実装済み
- ⚠️ 部分的実装/改善必要
- ❌ 未実装