import React, { useState } from 'react'
import './App.css'
import FileUpload from './components/FileUpload'
import ChartDisplay from './components/ChartDisplay'
import Statistics from './components/Statistics'
import FilterOptions from './components/FilterOptions'
import DualRailChart from './components/DualRailChart'
import DualRailStatistics from './components/DualRailStatistics'
import MTTResultDisplay from './components/MTTResultDisplay'

export interface TrackData {
  distance: number
  irregularity: number
}

export interface DataSet {
  data: TrackData[]
  statistics: {
    min: number
    max: number
    avg: number
    stdDev: number
  }
  filename?: string
}

export interface DualRailDataSet {
  leftRail: DataSet
  rightRail: DataSet
  filename?: string
}

// çµ±è¨ˆå€¤ã‚’è¨ˆç®—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function calculateStatistics(data: TrackData[]) {
  if (!data || data.length === 0) {
    return { min: 0, max: 0, avg: 0, stdDev: 0 }
  }

  const values = data.map(d => d.irregularity)
  const min = Math.min(...values)
  const max = Math.max(...values)
  const avg = values.reduce((a, b) => a + b, 0) / values.length

  const variance = values.reduce((sum, val) =>
    sum + Math.pow(val - avg, 2), 0
  ) / values.length
  const stdDev = Math.sqrt(variance)

  return { min, max, avg, stdDev }
}

function App() {
  // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ: 'single' = å˜ä¸€ãƒ¬ãƒ¼ãƒ«, 'dual' = å·¦å³ãƒ¬ãƒ¼ãƒ«åˆ¥
  const [railMode, setRailMode] = useState<'single' | 'dual'>('single')

  // å˜ä¸€ãƒ¬ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿
  const [originalData, setOriginalData] = useState<DataSet | null>(null)
  const [restoredData, setRestoredData] = useState<DataSet | null>(null)

  // å·¦å³ãƒ¬ãƒ¼ãƒ«åˆ¥ãƒ‡ãƒ¼ã‚¿
  const [dualRailData, setDualRailData] = useState<DualRailDataSet | null>(null)
  const [dualRailRestored, setDualRailRestored] = useState<DualRailDataSet | null>(null)

  const [loading, setLoading] = useState(false)
  const [filterType, setFilterType] = useState('moving_average_3')
  const [showAdvanced, setShowAdvanced] = useState(false)
  const [peaks, setPeaks] = useState<any>(null)
  const [mttResult, setMttResult] = useState<any>(null)

  // å·¦å³ãƒ¬ãƒ¼ãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  const [showLeft, setShowLeft] = useState(true)
  const [showRight, setShowRight] = useState(true)

  const handleFileUpload = async (file: File) => {
    setLoading(true)
    const formData = new FormData()
    formData.append('file', file)

    try {
      // å·¦å³ãƒ¬ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã§åˆ†å²
      const endpoint = railMode === 'dual' ? '/api/upload-dual-rail' : '/api/upload'

      const response = await fetch(endpoint, {
        method: 'POST',
        body: formData,
      })

      const result = await response.json()

      if (result.success) {
        if (railMode === 'dual') {
          // å·¦å³ãƒ¬ãƒ¼ãƒ«åˆ¥ãƒ‡ãƒ¼ã‚¿
          setDualRailData({
            leftRail: {
              data: result.leftRail.data,
              statistics: result.leftRail.statistics,
              filename: result.filename + ' (å·¦ãƒ¬ãƒ¼ãƒ«)'
            },
            rightRail: {
              data: result.rightRail.data,
              statistics: result.rightRail.statistics,
              filename: result.filename + ' (å³ãƒ¬ãƒ¼ãƒ«)'
            },
            filename: result.filename
          })
          setDualRailRestored(null)
        } else {
          // å˜ä¸€ãƒ¬ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿
          setOriginalData({
            data: result.data,
            statistics: result.statistics,
            filename: result.filename
          })
          setRestoredData(null)
        }
        setPeaks(null)
        setMttResult(null)
      } else {
        alert('ã‚¨ãƒ©ãƒ¼: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'))
      }
    } catch (error) {
      console.error('Upload error:', error)
      alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
    } finally {
      setLoading(false)
    }
  }

  const handleApplyFilter = async () => {
    if (!originalData) return

    setLoading(true)
    try {
      const response = await fetch('/api/apply-filter', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          data: originalData.data,
          filterType: filterType,
          options: {}
        }),
      })

      const result = await response.json()

      if (result.success) {
        setRestoredData({
          data: result.data,
          statistics: calculateStatistics(result.data),
          filename: `${originalData.filename} (${filterType})`
        })
      } else {
        alert('ã‚¨ãƒ©ãƒ¼: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'))
      }
    } catch (error) {
      console.error('Filter error:', error)
      alert('ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
    } finally {
      setLoading(false)
    }
  }

  const handleDetectPeaks = async () => {
    if (!originalData) return

    setLoading(true)
    try {
      const response = await fetch('/api/detect-peaks', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          data: originalData.data,
          options: {
            threshold: 2.0,
            minDistance: 5
          }
        }),
      })

      const result = await response.json()

      if (result.success) {
        setPeaks(result.peaks)
        alert(`${result.summary?.totalPeaks || 0}å€‹ã®ãƒ”ãƒ¼ã‚¯ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`)
      } else {
        alert('ã‚¨ãƒ©ãƒ¼: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'))
      }
    } catch (error) {
      console.error('Peak detection error:', error)
      alert('ãƒ”ãƒ¼ã‚¯æ¤œå‡ºã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
    } finally {
      setLoading(false)
    }
  }

  const handleCalculateMTT = async () => {
    if (!originalData) return

    setLoading(true)
    try {
      const response = await fetch('/api/calculate-mtt', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          data: originalData.data,
          params: {
            baseLength: 10.0,
            thresholds: {
              ç®¡ç†å€¤: 7.0,
              æ•´å‚™åŸºæº–å€¤: 12.0,
              ç·Šæ€¥æ•´å‚™å€¤: 20.0
            }
          }
        }),
      })

      const result = await response.json()

      if (result.success) {
        setMttResult(result)
        alert('MTTå€¤è¨ˆç®—ãŒå®Œäº†ã—ã¾ã—ãŸ')
      } else {
        alert('ã‚¨ãƒ©ãƒ¼: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'))
      }
    } catch (error) {
      console.error('MTT calculation error:', error)
      alert('MTTå€¤è¨ˆç®—ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
    } finally {
      setLoading(false)
    }
  }

  const handleExportData = async (format: string) => {
    if (!originalData) return

    setLoading(true)
    try {
      const response = await fetch('/api/export', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          data: restoredData?.data || originalData.data,
          format: format,
          options: {
            includeStatistics: true,
            includePeaks: peaks?.totalPeaks > 0,
            peaks: peaks
          }
        }),
      })

      if (format === 'json') {
        const result = await response.json()
        const blob = new Blob([JSON.stringify(result, null, 2)], { type: 'application/json' })
        const url = window.URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = `track_data_${Date.now()}.json`
        a.click()
        window.URL.revokeObjectURL(url)
      } else {
        const blob = await response.blob()
        const url = window.URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = `track_data_${Date.now()}.${format === 'excel' ? 'xlsx' : format}`
        a.click()
        window.URL.revokeObjectURL(url)
      }

      alert(`${format.toUpperCase()}å½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`)
    } catch (error) {
      console.error('Export error:', error)
      alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="App">
      <header className="header">
        <h1>ğŸš„ è»Œé“å¾©å…ƒã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>Rail Track Restoration System</p>
      </header>

      <div className="container">
        <section className="upload-section">
          <h2>ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
          <FileUpload onFileUpload={handleFileUpload} loading={loading} />
          {originalData && (
            <div className="info">
              <p>âœ“ ãƒ•ã‚¡ã‚¤ãƒ«: <strong>{originalData.filename}</strong></p>
              <p>âœ“ ãƒ‡ãƒ¼ã‚¿ç‚¹æ•°: <strong>{originalData.data.length}</strong> points</p>
            </div>
          )}
        </section>

        {originalData && (
          <>
            <section className="chart-section">
              <h2>è»Œé“æ³¢å½¢ãƒ‡ãƒ¼ã‚¿</h2>
              <ChartDisplay
                originalData={originalData.data}
                restoredData={restoredData?.data}
              />
            </section>

            <section className="stats-section">
              <h2>çµ±è¨ˆæƒ…å ±</h2>
              <div className="stats-grid">
                <Statistics
                  title="å…ƒãƒ‡ãƒ¼ã‚¿"
                  statistics={originalData.statistics}
                />
                {restoredData && (
                  <Statistics
                    title="å¾©å…ƒãƒ‡ãƒ¼ã‚¿"
                    statistics={restoredData.statistics}
                  />
                )}
              </div>
            </section>

            <section className="filter-section">
              <h2>ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†</h2>
              <FilterOptions
                filterType={filterType}
                onFilterChange={setFilterType}
                disabled={loading}
              />
              <div className="action-buttons">
                <button
                  className="btn btn-primary"
                  onClick={handleApplyFilter}
                  disabled={loading}
                >
                  {loading ? 'å‡¦ç†ä¸­...' : 'ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨'}
                </button>
              </div>
            </section>

            <section className="advanced-section">
              <h2>
                é«˜åº¦ãªåˆ†æ
                <button
                  className="btn btn-link"
                  onClick={() => setShowAdvanced(!showAdvanced)}
                >
                  {showAdvanced ? 'â–¼ é–‰ã˜ã‚‹' : 'â–¶ é–‹ã'}
                </button>
              </h2>

              {showAdvanced && (
                <div className="advanced-content">
                  <div className="analysis-grid">
                    <div className="analysis-card">
                      <h3>ãƒ”ãƒ¼ã‚¯æ¤œå‡º</h3>
                      <p>è»Œé“ç‹‚ã„ã®ãƒ”ãƒ¼ã‚¯ç®‡æ‰€ã‚’æ¤œå‡ºã—ã¾ã™</p>
                      <button
                        className="btn btn-secondary"
                        onClick={handleDetectPeaks}
                        disabled={loading}
                      >
                        ãƒ”ãƒ¼ã‚¯ã‚’æ¤œå‡º
                      </button>
                      {peaks.totalPeaks > 0 && (
                        <div className="result-info">
                          æ¤œå‡ºæ•°: <strong>{peaks.totalPeaks}</strong>ç®‡æ‰€
                        </div>
                      )}
                    </div>

                    <div className="analysis-card">
                      <h3>MTTå€¤è¨ˆç®—</h3>
                      <p>è»Œé“ã®ç·åˆè©•ä¾¡æŒ‡æ¨™ã‚’è¨ˆç®—ã—ã¾ã™</p>
                      <button
                        className="btn btn-secondary"
                        onClick={handleCalculateMTT}
                        disabled={loading}
                      >
                        MTTå€¤ã‚’è¨ˆç®—
                      </button>
                      {mttResult && (
                        <div className="result-info">
                          MTT: <strong>{mttResult.mtt?.toFixed(2)}</strong> mm
                          <br />
                          è©•ä¾¡: <strong>{mttResult.evaluation?.level}</strong>
                        </div>
                      )}
                    </div>

                    <div className="analysis-card">
                      <h3>ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
                      <p>å‡¦ç†çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã—ã¾ã™</p>
                      <div className="export-buttons">
                        <button
                          className="btn btn-secondary"
                          onClick={() => handleExportData('excel')}
                          disabled={loading}
                        >
                          Excelå‡ºåŠ›
                        </button>
                        <button
                          className="btn btn-secondary"
                          onClick={() => handleExportData('csv')}
                          disabled={loading}
                        >
                          CSVå‡ºåŠ›
                        </button>
                        <button
                          className="btn btn-secondary"
                          onClick={() => handleExportData('json')}
                          disabled={loading}
                        >
                          JSONå‡ºåŠ›
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </section>
          </>
        )}

        {!originalData && (
          <div className="empty-state">
            <p>ğŸ“Š CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
            <p className="note">
              ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: è·é›¢(m), è»Œé“ç‹‚ã„é‡(mm)<br />
              ä¾‹: 0.0, 2.5
            </p>
          </div>
        )}
      </div>

      <footer className="footer">
        <p>Based on Rail Track Restoration System (VB6 legacy)</p>
        <p>API: Express.js | Frontend: React + TypeScript</p>
      </footer>
    </div>
  )
}

export default App
