# 軌道復元システム - アプリケーション説明書

## 1. システム概要

### 1.1 プロジェクト名
**軌道復元システム (Rail Track Restoration System)**

### 1.2 概要
本システムは、既存のVisual Basic 6で開発された鉄道軌道復元システムを、最新のWeb技術でモダナイズしたアプリケーションです。鉄道軌道の検測データを処理し、軌道波形の可視化と復元計算を行うことで、鉄道保線業務の効率化と精度向上を実現します。

### 1.3 主な特徴
- **レガシーシステムの完全移行**: VB6のKCDW、KANA3、DCPZW等のシステムをWeb化
- **高度な軌道解析機能**: 偏心矢計算、FFT解析、MTT値計算等の専門的な解析機能
- **多様なデータ形式対応**: RSQ、キヤデータ、MDT、O010等の業界標準フォーマットをサポート
- **リアルタイムデータ可視化**: Plotly.jsによるインタラクティブなグラフ表示
- **バッチ処理対応**: 大量データの一括処理機能
- **レポート生成機能**: PDF、Excel形式での詳細レポート出力

## 2. システムアーキテクチャ

### 2.1 技術スタック

#### フロントエンド
- **React 18**: UIフレームワーク
- **TypeScript**: 型安全な開発
- **Vite**: 高速ビルドツール
- **Plotly.js**: 高性能データ可視化
- **Chart.js**: 基本チャート表示

#### バックエンド
- **Node.js**: JavaScriptランタイム
- **Express.js**: Webフレームワーク
- **Multer**: ファイルアップロード処理
- **カスタムパーサー群**: 各種データフォーマット解析エンジン

### 2.2 システム構成

```
rail-track-app/
├── frontend/                 # Reactフロントエンド
│   ├── src/
│   │   ├── components/      # 再利用可能なUIコンポーネント群
│   │   ├── pages/          # 各機能画面のページコンポーネント
│   │   ├── contexts/       # グローバル状態管理
│   │   └── App.tsx         # メインアプリケーション
│   └── package.json
│
├── backend/                  # Express APIサーバー
│   ├── src/
│   │   ├── algorithms/     # 計算アルゴリズム実装
│   │   ├── parsers/        # データパーサー群
│   │   ├── routes/         # APIエンドポイント定義
│   │   ├── utils/          # ユーティリティ関数
│   │   └── api-server.js   # APIサーバー (Port 5000)
│   └── package.json
│
└── README.md               # プロジェクトドキュメント
```

## 3. 主要機能詳細

### 3.1 データ処理機能

#### 3.1.1 対応データフォーマット
- **CSV**: 標準的な距離-軌道狂い量データ
- **RSQ**: 軌道検測データの標準フォーマット
- **キヤデータ**: 車両検測データ（LK、CK、O010形式）
- **MDT**: レガシー測定データ
- **軌道環境データ**: 線形情報、曲線諸元等

#### 3.1.2 データインポート機能
- ドラッグ&ドロップによる直感的なファイルアップロード
- 複数ファイルの一括処理
- 自動フォーマット認識と検証
- エンコーディング自動検出（Shift-JIS、UTF-8等）

### 3.2 軌道波形解析機能

#### 3.2.1 偏心矢計算
- **非対称弦長対応**: p ≠ q の任意パラメータ設定
- **検測特性係数計算**: A、B係数、振幅・位相特性
- **偏心矢変換**: 異なる検測特性間の相互変換
- **大規模データ最適化**: 100万点以上のデータ処理に対応

#### 3.2.2 復元波形計算
- **複数フィルタ対応**:
  - 移動平均フィルタ（3点、5点、7点）
  - FFTベースフィルタ
  - IIRフィルタ
  - ガウシアン平滑化
- **計画線編集機能**: 直線・曲線の手動設定と自動最適化

#### 3.2.3 統計解析
- 基本統計量（最小値、最大値、平均値、標準偏差）
- パーセンタイル分析
- 相関係数計算
- 異常値検出（統計的外れ値検出）

### 3.3 高度な解析機能

#### 3.3.1 MTT値計算
軌道の総合評価指標として、保線管理基準値（BC値、CD値）に基づいたMTT値を算出します。

#### 3.3.2 FFT解析（周波数解析）
- スペクトル分析
- 波長帯域別のパワースペクトル表示
- 特定波長帯のフィルタリング

#### 3.3.3 ピーク検出
- 自動ピーク検出アルゴリズム
- 閾値とピーク間距離の調整可能
- 極大値・極小値の個別検出

### 3.4 可視化機能

#### 3.4.1 インタラクティブグラフ
- **Plotly.js統合**: ズーム、パン、データポイント表示
- **複数系列比較**: 元データと復元データの重ね合わせ表示
- **左右レール別表示**: デュアルレールデータの同時表示

#### 3.4.2 グラフカスタマイズ
- 表示範囲の動的調整
- グリッド線、軸ラベルのカスタマイズ
- カラーテーマの切り替え

### 3.5 レポート生成機能

#### 3.5.1 PDF出力
- 計算結果の詳細レポート
- グラフ付き解析結果
- パラメータと統計情報の包括的なドキュメント

#### 3.5.2 Excel出力
- 複数シート構成（サマリー、詳細データ、統計、グラフ）
- フィルター機能付きデータテーブル
- 条件付き書式による視覚化

### 3.6 バッチ処理機能

複数ファイルの一括処理により、大量のデータセットを効率的に処理できます。
- 並列処理によるパフォーマンス最適化
- 進捗表示とエラーハンドリング
- 処理結果の統合レポート生成

## 4. 画面構成

### 4.1 メイン画面構成

アプリケーションは以下の主要画面で構成されています：

#### 4.1.1 ワークフロー画面（デフォルト）
初心者向けのガイド付きワークフロー画面。ステップバイステップで処理を進められます。

#### 4.1.2 上級者向け個別処理モード
経験者向けの高度な機能に直接アクセスできる画面。

### 4.2 機能別画面一覧

#### データ管理
- **データインポート**: 各種フォーマットのファイルインポート
- **ファイル形式変換**: フォーマット間の相互変換
- **キヤデータ処理**: キヤ141検測車データの専用処理
- **軌道環境データ**: 線形情報、曲線諸元の管理
- **レガシーデータ**: MDT、O010形式の旧システムデータ処理

#### 解析・計算
- **偏心矢計算**: 高精度偏心矢計算と変換
- **復元整正ワークスペース**: 波形復元と計画線編集の統合環境
- **アルゴリズム解析**: Bs05、HSJ、Y1Y2等の専門アルゴリズム
- **FFT解析**: 周波数領域での波形解析
- **MTT設定・計算**: 軌道評価指標の算出

#### 作業管理
- **作業区間設定**: 施工区間の定義
- **計画線設定**: 目標線形の設計
- **縦曲線設定**: 縦断線形の管理
- **固定点設定**: 基準点の管理
- **移動量制限**: 施工制約条件の設定

#### 出力・レポート
- **ALS出力**: ALS形式での出力
- **MJ出力**: MJ形式での出力
- **ALC出力**: ALC形式での出力
- **汎用出力**: CSV、JSON等の汎用形式
- **成果表作成**: 総合レポート生成

## 5. API仕様

### 5.1 APIサーバー情報
- **ポート**: 5000
- **ベースURL**: `http://localhost:5000/api`
- **形式**: RESTful API（JSON）

### 5.2 主要APIグループ

#### 5.2.1 ファイル管理API (`/api/files`)
- RSQ、HDR/DAT、DCP、PNT、TBL/DDB形式のアップロード
- ファイル一覧取得

#### 5.2.2 復元計算API (`/api/restoration`)
- 復元波形計算
- 計画線生成・編集
- 統計情報計算
- 周波数応答取得

#### 5.2.3 偏心矢計算API (`/api/eccentric-versine`)
- 偏心矢計算（大規模データ自動最適化）
- 検測特性係数計算
- 偏心矢間変換
- メモリ使用量推定

#### 5.2.4 レポートAPI (`/api/reports`)
- PDF/Excel形式のレポート生成
- テンプレート管理
- バッチレポート生成

## 6. 使用方法

### 6.1 システム要件
- Node.js 18以上
- npm または yarn
- 推奨ブラウザ: Chrome、Edge、Firefox（最新版）

### 6.2 インストール手順

1. **バックエンドセットアップ**
```bash
cd rail-track-app/backend
npm install
```

2. **フロントエンドセットアップ**
```bash
cd rail-track-app/frontend
npm install
```

### 6.3 起動方法

1. **バックエンドAPI起動**（ポート5000）
```bash
cd rail-track-app/backend
npm start
```

2. **フロントエンド起動**（ポート3000）
```bash
cd rail-track-app/frontend
npm run dev
```

3. **ブラウザアクセス**
```
http://localhost:3000
```

## 7. データフォーマット例

### 7.1 CSV形式（単一レール）
```csv
距離(m),軌道狂い量(mm)
0.0,2.5
0.5,2.8
1.0,3.2
```

### 7.2 CSV形式（左右レール）
```csv
距離(m),左レール(mm),右レール(mm)
0.0,2.5,2.3
0.5,2.8,2.6
1.0,3.1,2.9
```

### 7.3 偏心矢計算用JSON形式
```json
{
  "measurementData": [
    {"distance": 0, "value": 1.5},
    {"distance": 0.25, "value": 1.8}
  ],
  "p": 10,
  "q": 5,
  "samplingInterval": 0.25
}
```

## 8. パフォーマンス最適化

### 8.1 大規模データ処理
- **自動最適化**: 10,000点以上のデータで自動的に最適化版アルゴリズムを使用
- **チャンク処理**: メモリ効率を考慮した分割処理
- **LRUキャッシュ**: 頻繁に使用されるデータの高速アクセス

### 8.2 処理性能
- 小規模データ（1,000点）: 約2.24倍の高速化
- 大規模データ（500,000点）: メモリ使用量37%削減

## 9. セキュリティと制限事項

### 9.1 ファイルサイズ制限
- 最大アップロードサイズ: 50MB
- JSON/リクエストボディ: 50MB

### 9.2 CORS設定
クロスオリジンリクエストに対応（開発環境）

## 10. 開発履歴とバージョン情報

### 現在のバージョン
**v1.0.0** (Phase 17完了)

### 主要な開発フェーズ
- Phase 1-9: 基本システム構築
- Phase 10-11: キヤデータ・軌道環境データ統合
- Phase 12-15: 偏心矢計算実装とUI統合
- Phase 16: パフォーマンス最適化
- Phase 17: エクスポート機能拡張

## 11. サポートとトラブルシューティング

### 11.1 よくある問題と対処法

#### ポート競合エラー
```bash
# Windows
netstat -ano | findstr :5000
taskkill /PID <PID> /F

# Mac/Linux
lsof -ti:5000 | xargs kill -9
```

#### メモリ不足エラー
```bash
node --max-old-space-size=4096 src/api-server.js
```

### 11.2 問い合わせ先
技術的な問題が発生した場合は、GitHubのIssueトラッカーで報告してください。

## 12. ライセンス
MIT License

---
**開発元**: レールテック株式会社
**ベース**: Rail Track Restoration System (VB6 レガシーシステム)
**最終更新**: 2025年12月