# ソースコード説明書

## 目次
1. [プロジェクト全体構造](#1-プロジェクト全体構造)
2. [主要ファイルと役割](#2-主要ファイルと役割)
3. [技術スタック](#3-技術スタック)
4. [データフロー](#4-データフロー)
5. [主要機能の実装箇所](#5-主要機能の実装箇所)
6. [コンポーネント/モジュール詳細](#6-コンポーネントモジュール詳細)

---

## 1. プロジェクト全体構造

このプロジェクトは、軌道復元システムのモダンなWEBアプリケーション実装です。以下の3つの主要ディレクトリで構成されています。

```
rail-track-app/
├── frontend/          # Reactベースのフロントエンドアプリケーション
├── backend/           # Express.jsベースのローカル開発用APIサーバー
├── netlify/           # Netlify Functions用のサーバーレスAPI
├── netlify.toml       # Netlifyのデプロイ設定
├── package.json       # ルートレベルの依存関係とスクリプト
└── sample-data.csv    # テスト用のサンプルデータ
```

### 各ディレクトリの役割

#### frontend/
- **役割**: ユーザーインターフェースを提供するReact + TypeScriptアプリケーション
- **ビルドツール**: Vite (高速な開発サーバーとビルド)
- **開発サーバー**: ポート3000で起動
- **本番ビルド**: `dist/`ディレクトリに静的ファイルを出力
- **APIプロキシ**: 開発時は`/api/*`リクエストをlocalhost:3001にプロキシ

#### backend/
- **役割**: ローカル開発環境用のRESTful APIサーバー
- **ポート**: 3001
- **用途**: 開発時のAPIエンドポイント提供、ファイルアップロード処理
- **ストレージ**: ディスクベース (`uploads/`ディレクトリ)
- **注意**: 本番環境では使用されない (Netlify Functionsが代替)

#### netlify/
- **役割**: Netlifyへのデプロイ時に使用するサーバーレスAPI関数
- **実行環境**: AWS Lambda (Netlify Functions)
- **ストレージ**: メモリベース (永続化なし)
- **用途**: 本番環境でのAPIエンドポイント提供
- **コードの重複**: `backend/src/server.js`と同様の処理をサーバーレス用に最適化

---

## 2. 主要ファイルと役割

### ルートレベル

| ファイル | 役割 |
|---------|------|
| `netlify.toml` | Netlifyのビルド・デプロイ設定、リダイレクトルール定義 |
| `package.json` | プロジェクト全体の依存関係、デプロイスクリプト定義 |
| `sample-data.csv` | テスト用の軌道データサンプル |

### Backend (backend/)

| ファイル | 役割 |
|---------|------|
| `src/server.js` | Express.jsアプリケーションのメインファイル。全APIエンドポイント、ミドルウェア、計算ロジックを含む |
| `package.json` | バックエンド依存関係の定義 (express, cors, multer) |
| `uploads/` | アップロードされたCSVファイルの一時保存先 (処理後削除) |

### Frontend (frontend/)

| ファイル | 役割 |
|---------|------|
| `index.html` | SPAのエントリーHTMLファイル |
| `vite.config.ts` | Viteのビルド設定、APIプロキシ設定 |
| `tsconfig.json` | TypeScriptコンパイラ設定 |
| `src/main.tsx` | Reactアプリケーションのエントリーポイント |
| `src/App.tsx` | メインアプリケーションコンポーネント、状態管理とAPIコール |
| `src/components/FileUpload.tsx` | ファイルアップロードUI (ドラッグ&ドロップ対応) |
| `src/components/ChartDisplay.tsx` | Chart.jsを使用したグラフ表示コンポーネント |
| `src/components/Statistics.tsx` | 統計情報表示コンポーネント |
| `src/*.css` | 各コンポーネントのスタイル定義 |

### Netlify Functions (netlify/)

| ファイル | 役割 |
|---------|------|
| `functions/api.js` | サーバーレスAPI関数。backend/src/server.jsと同等の機能をserverless-http経由で提供 |

---

## 3. 技術スタック

### バックエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **Node.js** | 18+ (推奨) | JavaScriptランタイム環境 |
| **Express.js** | ^4.18.2 | WEBアプリケーションフレームワーク |
| **cors** | ^2.8.5 | Cross-Origin Resource Sharing対応 |
| **multer** | ^1.4.5-lts.1 | マルチパートフォームデータ(ファイルアップロード)処理 |
| **serverless-http** | ^3.2.0 | ExpressアプリをAWS Lambda用に変換 |

**モジュールシステム**: ES Modules (`"type": "module"`)

### フロントエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **React** | ^18.2.0 | UIライブラリ |
| **React DOM** | ^18.2.0 | ReactのDOM操作用ライブラリ |
| **TypeScript** | ^5.3.3 | 型安全な開発言語 |
| **Vite** | ^5.0.8 | 高速ビルドツール・開発サーバー |
| **Chart.js** | ^4.4.0 | データ可視化ライブラリ |
| **react-chartjs-2** | ^5.2.0 | Chart.jsのReactラッパー |
| **@vitejs/plugin-react** | ^4.2.1 | Vite用Reactプラグイン |

### デプロイ環境

| 技術 | 用途 |
|------|------|
| **Netlify** | 静的サイトホスティング + サーバーレス関数実行 |
| **Netlify CLI** | ローカル開発・デプロイツール |
| **AWS Lambda** | Netlify Functions実行基盤 |

---

## 4. データフロー

### 4.1 CSVファイルアップロードと解析の流れ

```
[ユーザー]
    ↓ (1) CSVファイルを選択/ドロップ
[FileUpload.tsx]
    ↓ (2) File オブジェクトをApp.tsxに渡す
[App.tsx - handleFileUpload]
    ↓ (3) FormDataを作成してPOSTリクエスト
[POST /api/upload]
    ↓ (4) multerがファイルを受信・検証
[backend/server.js or netlify/api.js]
    ↓ (5) CSVテキストを読み込み
[parseCSV関数]
    ↓ (6) カンマ区切りでパース → {distance, irregularity}[]
[calculateStatistics関数]
    ↓ (7) 統計値を計算 (min, max, avg, stdDev)
[APIレスポンス]
    ↓ (8) JSON形式でデータと統計を返却
[App.tsx]
    ↓ (9) originalData stateを更新
[ChartDisplay.tsx & Statistics.tsx]
    ↓ (10) UIを更新・グラフと統計を表示
[ユーザーに表示]
```

#### データ構造の変換

**CSVファイル**:
```csv
0.0, 2.5
0.5, 2.8
1.0, 3.2
```

**parseCSV処理後**:
```javascript
[
  { distance: 0.0, irregularity: 2.5 },
  { distance: 0.5, irregularity: 2.8 },
  { distance: 1.0, irregularity: 3.2 }
]
```

**APIレスポンス**:
```javascript
{
  success: true,
  filename: "sample.csv",
  dataPoints: 3,
  data: [...],
  statistics: {
    min: 2.5,
    max: 3.2,
    avg: 2.83,
    stdDev: 0.29
  }
}
```

### 4.2 波形復元処理の流れ

```
[ユーザー]
    ↓ (1) 「波形を復元」ボタンをクリック
[App.tsx - handleRestoreWaveform]
    ↓ (2) originalDataをリクエストボディに含めてPOST
[POST /api/restore-waveform]
    ↓ (3) filterType='simple'で3点移動平均フィルタを適用
[backend/server.js or netlify/api.js]
    ↓ (4) 各点について前後のデータを平均化
[復元アルゴリズム]
    ↓ (5) 元データと復元データの統計をそれぞれ計算
[APIレスポンス]
    ↓ (6) 元データと復元データの両方を返却
[App.tsx]
    ↓ (7) restoredData stateを更新
[ChartDisplay.tsx]
    ↓ (8) 元データと復元データの2本のラインを表示
[ユーザーに表示]
```

#### 復元アルゴリズム (3点移動平均)

```javascript
// 境界点 (最初と最後) はそのまま
if (i === 0 || i === data.length - 1) {
  restoredData[i] = originalData[i]
} else {
  // 前後の点と平均を取る
  restoredData[i].irregularity =
    (data[i-1].irregularity + data[i].irregularity + data[i+1].irregularity) / 3
}
```

### 4.3 状態管理フロー (React)

App.tsxで管理される主要な状態:

```typescript
const [originalData, setOriginalData] = useState<DataSet | null>(null)
const [restoredData, setRestoredData] = useState<DataSet | null>(null)
const [loading, setLoading] = useState(false)
```

**状態遷移**:
1. 初期状態: すべてnull/false
2. ファイルアップロード開始: loading=true
3. アップロード成功: originalData設定、restoredData=null、loading=false
4. 波形復元開始: loading=true
5. 復元成功: restoredData設定、loading=false

---

## 5. 主要機能の実装箇所

### 5.1 CSVファイルアップロード機能

**フロントエンド実装**:
- **ファイル**: `frontend/src/components/FileUpload.tsx`
- **主要機能**:
  - ドラッグ&ドロップ対応 (`onDragOver`, `onDrop` イベント)
  - ファイル選択ダイアログ (`<input type="file">`)
  - CSV拡張子の検証
  - ローディング状態の表示
- **Props**:
  ```typescript
  interface FileUploadProps {
    onFileUpload: (file: File) => void  // ファイル選択時のコールバック
    loading: boolean                     // ローディング状態
  }
  ```

**バックエンド実装**:
- **ファイル**: `backend/src/server.js` (行18-38)
- **主要機能**:
  - multerによるファイル受信設定
  - ディスクストレージ設定 (開発環境)
  - ファイル名の一意化 (タイムスタンプ + ランダム値)
  - MIMEタイプ検証 (`text/csv`)

**Netlify Functions実装**:
- **ファイル**: `netlify/functions/api.js` (行10-20)
- **主要機能**:
  - メモリストレージ設定 (サーバーレス環境)
  - 同様のMIMEタイプ検証

### 5.2 CSVパース機能

**実装箇所**:
- `backend/src/server.js` (行41-57)
- `netlify/functions/api.js` (行23-39)

**処理ロジック**:
```javascript
function parseCSV(csvText) {
  const lines = csvText.split('\n').filter(line => line.trim())
  const data = []

  for (const line of lines) {
    const values = line.split(',').map(v => v.trim())
    if (values.length >= 2) {
      const distance = parseFloat(values[0])
      const irregularity = parseFloat(values[1])
      if (!isNaN(distance) && !isNaN(irregularity)) {
        data.push({ distance, irregularity })
      }
    }
  }

  return data
}
```

**特徴**:
- 改行で分割、空行をフィルタリング
- カンマで値を分割、前後の空白を除去
- 2列以上のデータのみ処理
- 数値変換に失敗したデータは除外 (NaNチェック)

### 5.3 統計計算機能

**実装箇所**:
- `backend/src/server.js` (行86-101)
- `netlify/functions/api.js` (行69-82)

**計算内容**:
```javascript
function calculateStatistics(data) {
  const values = data.map(d => d.irregularity)

  // 基本統計量
  const min = Math.min(...values)
  const max = Math.max(...values)
  const avg = values.reduce((a, b) => a + b, 0) / values.length

  // 標準偏差
  const variance = values.reduce((sum, val) =>
    sum + Math.pow(val - avg, 2), 0
  ) / values.length
  const stdDev = Math.sqrt(variance)

  return { min, max, avg, stdDev }
}
```

**数学的定義**:
- **平均値**: μ = Σx / n
- **分散**: σ² = Σ(x - μ)² / n
- **標準偏差**: σ = √σ²

### 5.4 グラフ表示機能

**実装箇所**:
- `frontend/src/components/ChartDisplay.tsx`

**使用ライブラリ**:
- Chart.js (コアライブラリ)
- react-chartjs-2 (Reactラッパー)

**主要設定**:
```typescript
const options = {
  responsive: true,                    // レスポンシブ対応
  maintainAspectRatio: false,          // アスペクト比固定を解除
  plugins: {
    legend: { position: 'top' },       // 凡例を上部に配置
    title: {
      display: true,
      text: '軌道狂い量の推移'
    },
    tooltip: {                         // ツールチップのカスタマイズ
      callbacks: {
        label: (context) => `${context.parsed.y.toFixed(2)} mm`
      }
    }
  },
  scales: {
    x: {
      title: { text: '距離 (m)' },
      ticks: { maxTicksLimit: 20 }     // X軸の表示数制限
    },
    y: {
      title: { text: '軌道狂い量 (mm)' }
    }
  }
}
```

**データセット構成**:
- 元データ: 青緑色 (rgb(75, 192, 192))
- 復元データ: ピンク色 (rgb(255, 99, 132))
- 両方とも線グラフ (`Line` コンポーネント)

### 5.5 波形復元機能

**実装箇所**:
- `backend/src/server.js` (行168-210)
- `netlify/functions/api.js` (行204-246, 248-289)

**復元アルゴリズム**:
```javascript
app.post('/api/restore-waveform', (req, res) => {
  const { data, filterType = 'simple' } = req.body

  let restoredData = [...data]

  if (filterType === 'simple') {
    // 3点移動平均フィルタ
    restoredData = data.map((point, i) => {
      if (i === 0 || i === data.length - 1) {
        return point  // 境界点はそのまま
      }
      const avgIrregularity =
        (data[i-1].irregularity + point.irregularity + data[i+1].irregularity) / 3
      return { ...point, irregularity: avgIrregularity }
    })
  }

  // 元データと復元データの統計を計算
  const originalStats = calculateStatistics(data)
  const restoredStats = calculateStatistics(restoredData)

  res.json({
    success: true,
    original: { data, statistics: originalStats },
    restored: { data: restoredData, statistics: restoredStats },
    filterType
  })
})
```

**フィルタの特性**:
- **効果**: 高周波ノイズの除去、波形の平滑化
- **制限**: 境界点は処理しない (データ欠損を防ぐため)
- **将来の拡張**: filterTypeパラメータで異なるフィルタを実装可能

### 5.6 相関係数計算機能

**実装箇所**:
- `backend/src/server.js` (行59-84, 142-166)
- `netlify/functions/api.js` (行42-66, 153-177, 179-202)

**計算式**:
```javascript
function calculateCorrelation(data1, data2) {
  const n = Math.min(data1.length, data2.length)

  let sumX = 0, sumY = 0, sumXX = 0, sumYY = 0, sumXY = 0

  for (let i = 0; i < n; i++) {
    const x = data1[i].irregularity
    const y = data2[i].irregularity
    sumX += x
    sumY += y
    sumXX += x * x
    sumYY += y * y
    sumXY += x * y
  }

  const avgX = sumX / n
  const avgY = sumY / n

  const numerator = sumXY - n * avgX * avgY
  const denominator = Math.sqrt((sumXX - n * avgX * avgX) * (sumYY - n * avgY * avgY))

  if (denominator === 0) return 0
  return numerator / denominator
}
```

**数学的定義 (ピアソン相関係数)**:
```
r = (SUMXY - n·μx·μy) / √[(SUMXX - n·μx²)(SUMYY - n·μy²)]
```

**相関の判定基準**:
- r > 0.7: 強い正の相関
- 0.3 < r ≤ 0.7: 中程度の正の相関
- -0.3 ≤ r ≤ 0.3: 弱い相関
- -0.7 ≤ r < -0.3: 中程度の負の相関
- r < -0.7: 強い負の相関

---

## 6. コンポーネント/モジュール詳細

### 6.1 Backend: server.js

**ファイルパス**: `backend/src/server.js`

**構成要素**:

#### ミドルウェア設定 (行14-16)
```javascript
app.use(cors())              // CORS対応
app.use(express.json())      // JSONボディパース
```

#### multer設定 (行18-38)
```javascript
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, path.join(__dirname, '../uploads'))
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9)
    cb(null, uniqueSuffix + '-' + file.originalname)
  }
})

const upload = multer({
  storage: storage,
  fileFilter: (req, file, cb) => {
    if (file.mimetype === 'text/csv' || file.originalname.endsWith('.csv')) {
      cb(null, true)
    } else {
      cb(new Error('CSVファイルのみアップロード可能です'))
    }
  }
})
```

#### ヘルパー関数

**parseCSV** (行41-57):
- 役割: CSVテキストをJavaScriptオブジェクト配列に変換
- 入力: CSV文字列
- 出力: `{distance: number, irregularity: number}[]`

**calculateCorrelation** (行59-84):
- 役割: 2つのデータセットの相関係数を計算
- 入力: data1, data2 (TrackData配列)
- 出力: 相関係数 (-1 ~ 1)

**calculateStatistics** (行86-101):
- 役割: 基本統計量を計算
- 入力: data (TrackData配列)
- 出力: `{min, max, avg, stdDev}`

#### APIエンドポイント

**GET /api/health** (行104-106):
- 役割: ヘルスチェック
- レスポンス: `{status: 'ok', message: '...'}`

**POST /api/upload** (行109-140):
- 役割: CSVファイルのアップロードと解析
- ミドルウェア: `upload.single('file')`
- 処理:
  1. ファイル受信確認
  2. CSVテキスト読み込み (`fs.readFile`)
  3. パース処理
  4. 統計計算
  5. ファイル削除 (`fs.unlink`)
- レスポンス: データと統計情報

**POST /api/calculate-correlation** (行143-166):
- 役割: 相関係数の計算
- 入力: `{data1, data2}`
- 出力: 相関係数と説明文

**POST /api/restore-waveform** (行169-210):
- 役割: 波形復元処理
- 入力: `{data, filterType}`
- 出力: 元データと復元データの両方

#### サーバー起動 (行212-215)
```javascript
app.listen(PORT, () => {
  console.log(`Rail Track API server is running on http://localhost:${PORT}`)
})
```

### 6.2 Netlify Functions: api.js

**ファイルパス**: `netlify/functions/api.js`

**backend/src/server.jsとの違い**:
- **serverless-http**: ExpressアプリをLambda関数に変換 (行291)
- **メモリストレージ**: ファイルを`req.file.buffer`で処理 (行101, 130)
- **ファイル削除不要**: 一時ファイルが作成されない
- **重複エンドポイント**: `/api/upload`と`/upload`の両方を提供 (互換性のため)

**エクスポート**:
```javascript
export const handler = serverless(app)
```

このhandlerがNetlify Functionsによって実行されます。

### 6.3 Frontend: App.tsx

**ファイルパス**: `frontend/src/App.tsx`

**主要な型定義**:
```typescript
export interface TrackData {
  distance: number
  irregularity: number
}

export interface DataSet {
  data: TrackData[]
  statistics: {
    min: number
    max: number
    avg: number
    stdDev: number
  }
  filename?: string
}
```

**状態管理**:
```typescript
const [originalData, setOriginalData] = useState<DataSet | null>(null)
const [restoredData, setRestoredData] = useState<DataSet | null>(null)
const [loading, setLoading] = useState(false)
```

**主要関数**:

**handleFileUpload** (行28-57):
```typescript
const handleFileUpload = async (file: File) => {
  setLoading(true)
  const formData = new FormData()
  formData.append('file', file)

  try {
    const response = await fetch('/api/upload', {
      method: 'POST',
      body: formData,
    })

    const result = await response.json()

    if (result.success) {
      setOriginalData({
        data: result.data,
        statistics: result.statistics,
        filename: result.filename
      })
      setRestoredData(null)  // 前の復元データをクリア
    } else {
      alert('エラー: ' + (result.error || '不明なエラー'))
    }
  } catch (error) {
    console.error('Upload error:', error)
    alert('アップロードエラーが発生しました')
  } finally {
    setLoading(false)
  }
}
```

**handleRestoreWaveform** (行59-92):
```typescript
const handleRestoreWaveform = async () => {
  if (!originalData) return

  setLoading(true)
  try {
    const response = await fetch('/api/restore-waveform', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        data: originalData.data,
        filterType: 'simple'
      }),
    })

    const result = await response.json()

    if (result.success) {
      setRestoredData({
        data: result.restored.data,
        statistics: result.restored.statistics,
        filename: originalData.filename + ' (復元)'
      })
    } else {
      alert('エラー: ' + (result.error || '不明なエラー'))
    }
  } catch (error) {
    console.error('Restore error:', error)
    alert('波形復元エラーが発生しました')
  } finally {
    setLoading(false)
  }
}
```

**UIレンダリング構造**:
```jsx
<div className="App">
  <header>タイトル</header>
  <div className="container">
    {/* アップロードセクション */}
    <section className="upload-section">
      <FileUpload onFileUpload={handleFileUpload} loading={loading} />
    </section>

    {/* データがある場合のみ表示 */}
    {originalData && (
      <>
        {/* グラフセクション */}
        <section className="chart-section">
          <ChartDisplay originalData={...} restoredData={...} />
        </section>

        {/* 統計セクション */}
        <section className="stats-section">
          <Statistics title="元データ" statistics={...} />
          {restoredData && <Statistics title="復元データ" statistics={...} />}
        </section>

        {/* アクションセクション */}
        <section className="actions-section">
          <button onClick={handleRestoreWaveform}>波形を復元</button>
        </section>
      </>
    )}

    {/* 空の状態 */}
    {!originalData && (
      <div className="empty-state">
        <p>CSVファイルをアップロードしてください</p>
      </div>
    )}
  </div>
  <footer>フッター情報</footer>
</div>
```

### 6.4 Frontend: FileUpload.tsx

**ファイルパス**: `frontend/src/components/FileUpload.tsx`

**Props定義**:
```typescript
interface FileUploadProps {
  onFileUpload: (file: File) => void  // ファイル選択時のコールバック
  loading: boolean                     // ローディング状態
}
```

**主要機能実装**:

**ファイル選択ハンドラ** (行12-17):
```typescript
const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0]
  if (file) {
    onFileUpload(file)
  }
}
```

**ドラッグオーバーハンドラ** (行19-22):
```typescript
const handleDragOver = (e: React.DragEvent) => {
  e.preventDefault()    // デフォルトのドロップ動作を防ぐ
  e.stopPropagation()   // 親要素への伝播を防ぐ
}
```

**ドロップハンドラ** (行24-34):
```typescript
const handleDrop = (e: React.DragEvent) => {
  e.preventDefault()
  e.stopPropagation()

  const file = e.dataTransfer.files?.[0]
  if (file && file.name.endsWith('.csv')) {
    onFileUpload(file)
  } else {
    alert('CSVファイルのみアップロード可能です')
  }
}
```

**クリックハンドラ** (行36-38):
```typescript
const handleClick = () => {
  fileInputRef.current?.click()  // 非表示のinputをプログラムでクリック
}
```

**UI構造**:
```jsx
<div className="file-upload">
  <div className="drop-zone" onDragOver={...} onDrop={...} onClick={...}>
    <input type="file" ref={fileInputRef} onChange={...} accept=".csv" style={{display: 'none'}} />
    <div className="drop-zone-content">
      {loading ? (
        <div className="spinner"></div>  {/* ローディング表示 */}
      ) : (
        <>
          <svg>アップロードアイコン</svg>
          <p>CSVファイルをドラッグ&ドロップ</p>
          <button>ファイルを選択</button>
        </>
      )}
    </div>
  </div>
</div>
```

### 6.5 Frontend: ChartDisplay.tsx

**ファイルパス**: `frontend/src/components/ChartDisplay.tsx`

**Chart.js登録** (行15-23):
```typescript
ChartJS.register(
  CategoryScale,    // X軸カテゴリスケール
  LinearScale,      // Y軸線形スケール
  PointElement,     // ポイント要素
  LineElement,      // ライン要素
  Title,            // タイトルプラグイン
  Tooltip,          // ツールチッププラグイン
  Legend            // 凡例プラグイン
)
```

**Props定義**:
```typescript
interface ChartDisplayProps {
  originalData: TrackData[]
  restoredData?: TrackData[]  // オプショナル
}
```

**データセット作成ロジック** (行36-60):
```typescript
const labels = originalData.map(d => d.distance.toFixed(1))

const datasets = [
  {
    label: '元データ (Original)',
    data: originalData.map(d => d.irregularity),
    borderColor: 'rgb(75, 192, 192)',
    backgroundColor: 'rgba(75, 192, 192, 0.5)',
    tension: 0.1,        // 線の滑らかさ
    pointRadius: 2,      // ポイントのサイズ
    pointHoverRadius: 5, // ホバー時のポイントサイズ
  }
]

if (restoredData) {
  datasets.push({
    label: '復元データ (Restored)',
    data: restoredData.map(d => d.irregularity),
    borderColor: 'rgb(255, 99, 132)',
    backgroundColor: 'rgba(255, 99, 132, 0.5)',
    tension: 0.1,
    pointRadius: 2,
    pointHoverRadius: 5,
  })
}
```

**チャートオプション** (行67-111):
- **responsive**: ウィンドウサイズに応じて自動調整
- **maintainAspectRatio: false**: コンテナに合わせてサイズ変更
- **plugins.legend**: 凡例を上部に配置
- **plugins.title**: グラフタイトル設定
- **plugins.tooltip.callbacks**: ツールチップのカスタマイズ (mm単位表示)
- **scales.x**: X軸設定 (距離)
- **scales.y**: Y軸設定 (軌道狂い量)

**レンダリング**:
```jsx
<div className="chart-display">
  <div className="chart-container">
    <Line data={data} options={options} />
  </div>
</div>
```

### 6.6 Frontend: Statistics.tsx

**ファイルパス**: `frontend/src/components/Statistics.tsx`

**Props定義**:
```typescript
interface StatisticsProps {
  title: string
  statistics: {
    min: number
    max: number
    avg: number
    stdDev: number
  }
}
```

**コンポーネント構造**:
```jsx
<div className="statistics">
  <h3>{title}</h3>
  <div className="stat-item">
    <span className="stat-label">最小値 (Min):</span>
    <span className="stat-value">{statistics.min.toFixed(2)} mm</span>
  </div>
  <div className="stat-item">
    <span className="stat-label">最大値 (Max):</span>
    <span className="stat-value">{statistics.max.toFixed(2)} mm</span>
  </div>
  <div className="stat-item">
    <span className="stat-label">平均値 (Avg):</span>
    <span className="stat-value">{statistics.avg.toFixed(2)} mm</span>
  </div>
  <div className="stat-item">
    <span className="stat-label">標準偏差 (StdDev):</span>
    <span className="stat-value">{statistics.stdDev.toFixed(2)} mm</span>
  </div>
</div>
```

**数値フォーマット**: すべての値を小数点2桁で表示 (`toFixed(2)`)

### 6.7 設定ファイル

#### vite.config.ts

**ファイルパス**: `frontend/vite.config.ts`

```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000,           // 開発サーバーポート
    proxy: {
      '/api': {
        target: 'http://localhost:3001',  // バックエンドAPI
        changeOrigin: true
      }
    }
  }
})
```

**プロキシの役割**:
- 開発時に`http://localhost:3000/api/*`へのリクエストを`http://localhost:3001/api/*`に転送
- CORS問題を回避
- 本番環境ではNetlifyのリダイレクトルールが代替

#### netlify.toml

**ファイルパス**: `netlify.toml`

```toml
[build]
  base = "frontend"        # ビルドのベースディレクトリ
  publish = "dist"         # 公開する静的ファイルのディレクトリ

[functions]
  directory = "netlify/functions"  # サーバーレス関数のディレクトリ
  node_bundler = "esbuild"         # バンドラー設定

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/api/:splat"  # /api/* → Netlify Functions
  status = 200
  force = true

[[redirects]]
  from = "/*"
  to = "/index.html"       # SPAのルーティング対応 (すべてをindex.htmlに)
  status = 200
```

**リダイレクトルールの意味**:
1. `/api/*`へのリクエストはNetlify Functionsに転送
2. それ以外のすべてのリクエストは`index.html`に転送 (React Routerなどのクライアントサイドルーティング対応)

---

## 補足情報

### 開発とデプロイの違い

| 項目 | 開発環境 | 本番環境 (Netlify) |
|------|---------|-------------------|
| フロントエンド | Vitedev server (localhost:3000) | Netlifyの静的ホスティング |
| バックエンド | Express server (localhost:3001) | Netlify Functions (AWS Lambda) |
| APIプロキシ | Viteのproxy設定 | Netlifyのリダイレクトルール |
| ファイルストレージ | ディスク (`uploads/`) | メモリ (`req.file.buffer`) |
| コード | `backend/src/server.js` | `netlify/functions/api.js` |

### コードの重複について

`backend/src/server.js`と`netlify/functions/api.js`は多くのコードが重複していますが、これは以下の理由によります:

1. **開発環境とデプロイ環境の分離**: ローカルでの高速な開発とサーバーレス環境での動作を両立
2. **ストレージ戦略の違い**: ディスクベース vs メモリベース
3. **デプロイの独立性**: フロントエンドとバックエンドを個別にデプロイ可能

**改善案**: 共通ロジック (parseCSV, calculateStatistics, calculateCorrelationなど) を別ファイルに抽出し、両方からインポートすることでDRY原則に従うことが可能。

### セキュリティ考慮事項

現在の実装では以下のセキュリティ対策が不足しています:

1. **ファイルサイズ制限**: 大きすぎるファイルのアップロードを防ぐ
2. **レート制限**: API呼び出しの頻度制限
3. **入力検証**: CSVデータの形式・内容の厳密な検証
4. **認証・認可**: ユーザー認証機能がない
5. **CSRFトークン**: クロスサイトリクエストフォージェリ対策

本番環境では上記の対策を追加することを推奨します。

### パフォーマンス最適化のポイント

1. **フロントエンド**:
   - Chart.jsのデータポイント数制限 (1000点以上の場合はサンプリング)
   - React.memoを使用したコンポーネントの再レンダリング抑制
   - 大きなデータセットの場合はvirtualizationを検討

2. **バックエンド**:
   - ストリーミングCSVパース (大ファイル対応)
   - 計算結果のキャッシング
   - Worker Threadsを使用した並列処理

3. **Netlify Functions**:
   - コールドスタート対策 (関数のウォームアップ)
   - メモリ設定の最適化
   - タイムアウト設定の調整

---

**ドキュメントバージョン**: 1.0
**最終更新日**: 2025年
**対象ソースコード**: rail-track-app v1.0.0
